(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();function v(r,e,t){return window.go.main.App.AddMessage(r,e,t)}function I(){return window.go.main.App.CheckOllamaInstalled()}function C(r,e){return window.go.main.App.CreateChat(r,e)}function L(){return window.go.main.App.DeleteAllChats()}function k(r){return window.go.main.App.DeleteChat(r)}function B(r,e){return window.go.main.App.GenerateWithOllama(r,e)}function S(r,e){return window.go.main.App.GetChatContext(r,e)}function N(r){return window.go.main.App.GetChatMessages(r)}function T(){return window.go.main.App.GetChats()}function y(){return window.go.main.App.GetInstalledModels()}function w(r){return window.go.main.App.Greet(r)}function b(r,e){return window.go.main.App.OnFileChange(r,e)}function x(){return window.go.main.App.OpenFile()}function A(r){return window.go.main.App.RenameChatFromFirstMessage(r)}function E(r,e,t){return window.go.main.App.SaveFile(r,e,t)}function g(r,e,t){return window.go.main.App.SaveFileAs(r,e,t)}function F(r){return window.go.main.App.SearchChats(r)}function M(){return window.go.main.App.StartOllamaServer()}function D(r,e){return window.go.main.App.UpdateChatTitle(r,e)}console.log("Akashic Editor Starting...");class O{constructor(){this.tabs=[],this.activeTabId=null,this.tabCounter=0,this.zoomLevel=100,this.ollamaStatus={installed:!1,checked:!1},this.installedModels=[],this.selectedModel="",this.serverRunning=!1,this.currentGeneration=null,this.lastAIResponse="",this.currentChatId=null,this.chats=[],this.isLoadingChat=!1,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.init()):this.init()}async init(){if(console.log("Initializing Akashic Editor..."),this.elements={tabsContainer:document.getElementById("tabs-container"),newTabBtn:document.getElementById("new-tab-btn"),editorContainer:document.getElementById("editor-container"),aiSidebar:document.getElementById("ai-sidebar"),statusFile:document.getElementById("status-file"),statusEncoding:document.getElementById("status-encoding"),statusLineEnding:document.getElementById("status-line-ending"),statusPosition:document.getElementById("status-position"),statusZoom:document.getElementById("status-zoom"),contextMenu:document.getElementById("context-menu"),dialogOverlay:document.getElementById("dialog-overlay"),chatHistoryPanel:document.getElementById("chat-history-panel"),chatList:document.getElementById("chat-list"),chatSearch:document.getElementById("chat-search"),currentChatTitle:document.getElementById("current-chat-title"),chatInfo:document.getElementById("chat-info")},!this.elements.editorContainer){console.error("Editor container not found!"),document.body.innerHTML='<div style="color: red; padding: 20px;">Error: Editor container not found</div>';return}if(this.setupMenus(),this.setupKeyboardShortcuts(),this.setupEventListeners(),this.setupAIEventListeners(),this.setupChatHistoryListeners(),this.createNewTab(),w)try{const e=await w("Developer");console.log("Wails connected:",e)}catch(e){console.warn("Wails greeting failed:",e)}await this.loadChatHistory(),console.log("Editor initialized successfully")}async loadChatHistory(){try{this.chats=await T(),this.renderChatList()}catch(e){console.error("Failed to load chat history:",e)}}renderChatList(){if(!!this.elements.chatList){if(this.elements.chatList.innerHTML="",this.chats.length===0){this.elements.chatList.innerHTML=`
                <div class="chat-empty">
                    <p>No chats yet</p>
                    <span>Start a new conversation</span>
                </div>
            `;return}this.chats.forEach(e=>{const t=document.createElement("div");t.className="chat-item",t.dataset.chatId=e.id,e.id===this.currentChatId&&t.classList.add("active");const n=new Date(e.updatedAt),i=n.toLocaleDateString()+" "+n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t.innerHTML=`
                <div class="chat-item-content">
                    <div class="chat-item-title">${this.escapeHtml(e.title)}</div>
                    <div class="chat-item-meta">
                        <span class="chat-item-model">${e.modelName}</span>
                        <span class="chat-item-time">${i}</span>
                    </div>
                </div>
                <button class="chat-item-delete" title="Delete chat">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            `,t.querySelector(".chat-item-content").addEventListener("click",()=>{this.loadChat(e.id)}),t.querySelector(".chat-item-delete").addEventListener("click",s=>{s.stopPropagation(),this.deleteChat(e.id)}),this.elements.chatList.appendChild(t)})}}async createNewChat(){try{const t=await C("New Chat",this.selectedModel||"default");this.currentChatId=t.id,this.chats.unshift(t);const n=document.getElementById("ai-messages");n.innerHTML=`
                <div class="ai-welcome">
                    <div class="ai-welcome-icon">\u{1F916}</div>
                    <h3>How can I help you today?</h3>
                    <p>I can help you write, edit, explain code, summarize text, and more.</p>
                    <div class="ai-suggestions">
                        <button class="ai-suggestion" data-prompt="Explain this code">\u{1F4A1} Explain code</button>
                        <button class="ai-suggestion" data-prompt="Rewrite this to be more professional">\u270D\uFE0F Rewrite professionally</button>
                        <button class="ai-suggestion" data-prompt="Summarize this text">\u{1F4DD} Summarize</button>
                        <button class="ai-suggestion" data-prompt="Fix grammar and spelling">\u{1F527} Fix grammar</button>
                    </div>
                </div>
            `,n.querySelectorAll(".ai-suggestion").forEach(i=>{i.addEventListener("click",()=>{const s=i.dataset.prompt;document.getElementById("ai-prompt").value=s,this.generateWithAI()})}),this.renderChatList(),this.updateChatInfo()}catch(e){console.error("Failed to create chat:",e),this.showNotification("Failed to create chat","error")}}async loadChat(e){if(!this.isLoadingChat){this.isLoadingChat=!0;try{this.currentChatId=e;const t=await N(e),n=document.getElementById("ai-messages");n.innerHTML="",t.length===0?n.innerHTML=`
                    <div class="ai-welcome">
                        <div class="ai-welcome-icon">\u{1F916}</div>
                        <h3>How can I help you today?</h3>
                        <p>I can help you write, edit, explain code, summarize text, and more.</p>
                    </div>
                `:(t.forEach(s=>{const a=document.createElement("div");a.className=`ai-message ${s.role}`,a.innerHTML=`<div class="ai-message-content">${this.escapeHtml(s.content)}</div>`,n.appendChild(a)}),n.scrollTop=n.scrollHeight);const i=this.chats.find(s=>s.id===e);i&&(this.selectedModel=i.modelName,document.getElementById("ai-model").value=i.modelName),this.renderChatList(),this.updateChatInfo()}catch(t){console.error("Failed to load chat:",t),this.showNotification("Failed to load chat","error")}finally{this.isLoadingChat=!1}}}async deleteChat(e){const t=this.chats.find(i=>i.id===e),n=t?t.title:"this chat";this.showStyledConfirmDialog("Delete Chat",`Are you sure you want to delete "${n}"?`,"Delete","Cancel",async()=>{try{if(await k(e),this.chats=this.chats.filter(i=>i.id!==e),this.currentChatId===e){this.currentChatId=null;const i=document.getElementById("ai-messages");i.innerHTML=`
                            <div class="ai-welcome">
                                <div class="ai-welcome-icon">\u{1F916}</div>
                                <h3>How can I help you today?</h3>
                            </div>
                        `,this.updateChatInfo()}this.renderChatList(),this.showNotification("Chat deleted","success")}catch(i){console.error("Failed to delete chat:",i),this.showNotification("Failed to delete chat","error")}})}async clearAllChats(){this.showStyledConfirmDialog("Clear All Chats",`Are you sure you want to delete ALL ${this.chats.length} chat(s)? This action cannot be undone.`,"Delete All","Cancel",async()=>{try{await L(),this.chats=[],this.currentChatId=null;const e=document.getElementById("ai-messages");e.innerHTML=`
                        <div class="ai-welcome">
                            <div class="ai-welcome-icon">\u{1F916}</div>
                            <h3>How can I help you today?</h3>
                        </div>
                    `,this.renderChatList(),this.updateChatInfo(),this.showNotification("All chats cleared","success")}catch(e){console.error("Failed to clear chats:",e),this.showNotification("Failed to clear chats","error")}})}async searchChats(e){if(!e.trim()){await this.loadChatHistory();return}try{this.chats=await F(e),this.renderChatList()}catch(t){console.error("Failed to search chats:",t)}}async renameCurrentChat(){if(!this.currentChatId)return;const e=this.chats.find(t=>t.id===this.currentChatId);!e||this.showRenameChatDialog(e.title,async t=>{if(!(!t||t===e.title))try{await D(this.currentChatId,t),e.title=t,this.renderChatList(),this.updateChatInfo(),this.showNotification("Chat renamed","success")}catch(n){console.error("Failed to rename chat:",n),this.showNotification("Failed to rename chat","error")}})}showRenameChatDialog(e,t){this.elements.dialogOverlay.classList.remove("hidden");const n="dialog-rename-chat";let i=document.getElementById(n);i||(i=document.createElement("div"),i.id=n,i.className="dialog hidden",i.style.width="350px",i.innerHTML=`
                <div class="dialog-header" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">\u270F\uFE0F</span>
                    <span>Rename Chat</span>
                </div>
                <div class="dialog-body" style="padding: 20px;">
                    <input type="text" id="rename-chat-input" placeholder="Enter chat name..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;">
                </div>
                <div class="dialog-footer" style="justify-content: flex-end; gap: 10px; padding: 15px 20px;">
                    <button id="rename-chat-cancel" style="padding: 6px 16px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button id="rename-chat-save" style="padding: 6px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(i));const s=document.getElementById("rename-chat-input");s.value=e,i.classList.remove("hidden"),setTimeout(()=>{s.focus(),s.select()},10);const a=document.getElementById("rename-chat-save"),l=document.getElementById("rename-chat-cancel"),o=a.cloneNode(!0),c=l.cloneNode(!0);a.parentNode.replaceChild(o,a),l.parentNode.replaceChild(c,l);const d=()=>{this.hideDialogs(),i.classList.add("hidden")};o.addEventListener("click",()=>{const h=s.value.trim();d(),t&&t(h)}),c.addEventListener("click",()=>{d()}),s.addEventListener("keydown",h=>{if(h.key==="Enter"){const u=s.value.trim();d(),t&&t(u)}else h.key==="Escape"&&d()})}updateChatInfo(){if(!(!this.elements.chatInfo||!this.elements.currentChatTitle))if(this.currentChatId){const e=this.chats.find(t=>t.id===this.currentChatId);e&&(this.elements.currentChatTitle.textContent=e.title,this.elements.chatInfo.classList.remove("hidden"))}else this.elements.chatInfo.classList.add("hidden")}setupChatHistoryListeners(){const e=document.getElementById("new-chat-btn");e&&e.addEventListener("click",()=>this.createNewChat());const t=document.getElementById("clear-all-chats");t&&t.addEventListener("click",()=>this.clearAllChats()),this.elements.chatSearch&&this.elements.chatSearch.addEventListener("input",i=>{this.searchChats(i.target.value)});const n=document.getElementById("rename-chat-btn");n&&n.addEventListener("click",()=>this.renameCurrentChat())}createNewTab(e=null,t=""){const n=`tab-${++this.tabCounter}`;console.log("Creating new tab:",n);const i={id:n,fileInfo:e||{Path:"",Name:"Untitled",Encoding:"UTF-8",LineEnding:"CRLF",IsDirty:!1,IsNewFile:!0},content:t||"",textarea:null};return this.tabs.push(i),this.renderTab(i),this.switchToTab(n),i}renderTab(e){const t=document.createElement("div");t.className="tab",t.dataset.tabId=e.id,t.innerHTML=`
            <span class="tab-dirty" style="display: none;">\u25CF</span>
            <span class="tab-name">${e.fileInfo.Name}</span>
            <span class="tab-close">\xD7</span>
        `,t.addEventListener("click",n=>{n.target.classList.contains("tab-close")?this.closeTab(e.id):this.switchToTab(e.id)}),this.elements.tabsContainer.appendChild(t),e.element=t}switchToTab(e){if(console.log("Switching to tab:",e),this.activeTabId){const n=this.tabs.find(i=>i.id===this.activeTabId);n&&n.textarea&&(n.content=n.textarea.value,n.element.classList.remove("active"))}this.activeTabId=e;const t=this.tabs.find(n=>n.id===e);t&&(t.element.classList.add("active"),this.elements.editorContainer.innerHTML="",this.createTextareaEditor(t),this.updateStatusBar())}createTextareaEditor(e){console.log("Creating textarea editor for:",e.id);const t=document.createElement("textarea");t.className="editor-textarea",t.value=e.content,t.spellcheck=!1,t.wrap="off",t.style.fontSize=`${this.zoomLevel}%`,t.addEventListener("input",()=>{this.onEditorChange(e)}),t.addEventListener("click",()=>{this.updateCursorPosition(e)}),t.addEventListener("keyup",()=>{this.updateCursorPosition(e)}),t.addEventListener("keydown",n=>{if(n.key==="Tab"){n.preventDefault();const i=t.selectionStart,s=t.selectionEnd;t.value=t.value.substring(0,i)+"	"+t.value.substring(s),t.selectionStart=t.selectionEnd=i+1,this.onEditorChange(e)}}),this.elements.editorContainer.appendChild(t),e.textarea=t,setTimeout(()=>{t.focus(),console.log("Textarea focused")},10)}onEditorChange(e){if(e.content=e.textarea.value,!e.fileInfo.IsDirty){e.fileInfo.IsDirty=!0;const t=e.element.querySelector(".tab-dirty");t&&(t.style.display="inline")}if(b)try{b(e.fileInfo.Path,!0)}catch{}}updateCursorPosition(e){if(!e.textarea)return;const t=e.textarea.value,n=e.textarea.selectionStart,i=t.substring(0,n).split(`
`),s=i.length,a=i[i.length-1].length+1;this.elements.statusPosition.textContent=`Ln ${s}, Col ${a}`}closeTab(e){const t=this.tabs.findIndex(i=>i.id===e);if(t===-1)return;const n=this.tabs[t];if(n.fileInfo.IsDirty){this.showSaveConfirmDialog("Unsaved Changes",`Save changes to ${n.fileInfo.Name}?`,()=>this.saveAndCloseTab(n,e),()=>this.forceCloseTab(e));return}this.forceCloseTab(e)}async saveAndCloseTab(e,t){await this.saveTab(e),this.forceCloseTab(t)}forceCloseTab(e){const t=this.tabs.findIndex(i=>i.id===e);if(t===-1)return;if(this.tabs[t].element.remove(),this.tabs.splice(t,1),this.activeTabId===e)if(this.tabs.length>0){const i=Math.min(t,this.tabs.length-1);this.switchToTab(this.tabs[i].id)}else this.activeTabId=null,this.createNewTab()}async newFile(){console.log("Creating new file"),this.createNewTab()}async openFile(){if(console.log("Opening file..."),!x){this.showNotification("File dialog not available","error");return}try{const e=await x();if(console.log("OpenFile result:",e),!e){console.log("No file selected");return}const t=e.fileInfo,n=e.content||"";if(t){console.log("File opened:",t.name);const i={Path:t.path||"",Name:t.name||"Untitled",Encoding:t.encoding||"UTF-8",LineEnding:t.lineEnding||"CRLF",IsDirty:t.isDirty||!1,IsNewFile:t.isNewFile||!1};this.createNewTab(i,n)}}catch(e){console.error("Failed to open file:",e),this.showNotification("Failed to open file: "+(e.message||e),"error")}}async saveTab(e=null){if(e||(e=this.tabs.find(n=>n.id===this.activeTabId)),!e||!e.textarea)return;const t=e.textarea.value;if(console.log("Saving file:",e.fileInfo.Name),!E||!g){this.showNotification("Save not available","error");return}try{let n;if(e.fileInfo.IsNewFile||!e.fileInfo.Path?n=await g(e.fileInfo.Name,t,e.fileInfo.LineEnding):n=await E(e.fileInfo.Path,t,e.fileInfo.LineEnding),n){const i={Path:n.path||n.Path||"",Name:n.name||n.Name||"Untitled",Encoding:n.encoding||n.Encoding||"UTF-8",LineEnding:n.lineEnding||n.LineEnding||"CRLF",IsDirty:!1,IsNewFile:n.isNewFile||n.IsNewFile||!1};e.fileInfo=i;const s=e.element.querySelector(".tab-name"),a=e.element.querySelector(".tab-dirty");s&&(s.textContent=i.Name),a&&(a.style.display="none"),this.updateStatusBar(),this.showNotification("File saved: "+i.Name,"success"),console.log("File saved:",i.Name)}}catch(n){console.error("Failed to save:",n),this.showNotification("Failed to save file: "+(n.message||n),"error")}}async saveAs(){const e=this.tabs.find(n=>n.id===this.activeTabId);if(!e||!e.textarea)return;const t=e.textarea.value;if(!g){this.showNotification("Save As not available","error");return}try{const n=await g(e.fileInfo.Name,t,e.fileInfo.LineEnding);if(n){const i={Path:n.path||n.Path||"",Name:n.name||n.Name||"Untitled",Encoding:n.encoding||n.Encoding||"UTF-8",LineEnding:n.lineEnding||n.LineEnding||"CRLF",IsDirty:!1,IsNewFile:n.isNewFile||n.IsNewFile||!1};e.fileInfo=i;const s=e.element.querySelector(".tab-name"),a=e.element.querySelector(".tab-dirty");s&&(s.textContent=i.Name),a&&(a.style.display="none"),this.updateStatusBar(),this.showNotification("File saved: "+i.Name,"success")}}catch(n){console.error("Failed to save:",n),this.showNotification("Failed to save file: "+(n.message||n),"error")}}setupMenus(){console.log("Setting up menus..."),document.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.menu;this.toggleMenu(n)})}),document.querySelectorAll(".dropdown").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=t.target.closest(".menu-option");if(n){const i=n.dataset.action;console.log("Menu action:",i),this.handleMenuAction(i),this.hideAllMenus()}})}),document.querySelectorAll(".context-item").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.action;this.handleContextAction(n),this.elements.contextMenu.classList.add("hidden")})}),document.addEventListener("click",e=>{!e.target.closest("#menu-bar")&&!e.target.closest(".dropdown")&&this.hideAllMenus(),this.elements.contextMenu.classList.add("hidden")})}toggleMenu(e){const t=document.getElementById(`menu-${e}`),n=document.querySelector(`[data-menu="${e}"]`);if(!t||!n){console.warn("Menu not found:",e);return}const i=t.classList.contains("show");if(this.hideAllMenus(),!i){t.classList.add("show");const s=n.getBoundingClientRect();t.style.left=`${s.left}px`,t.style.top=`${s.bottom}px`}}hideAllMenus(){document.querySelectorAll(".dropdown").forEach(e=>e.classList.remove("show"))}handleMenuAction(e){switch(console.log("Handling menu action:",e),e){case"new":this.newFile();break;case"open":this.openFile();break;case"save":this.saveTab();break;case"save-as":this.saveAs();break;case"exit":this.exitApp();break;case"undo":document.execCommand("undo");break;case"redo":document.execCommand("redo");break;case"cut":document.execCommand("cut");break;case"copy":document.execCommand("copy");break;case"paste":document.execCommand("paste");break;case"find":this.showFindReplaceDialog(!1);break;case"replace":this.showFindReplaceDialog(!0);break;case"go-to":this.showGoToDialog();break;case"zoom-in":this.zoomIn();break;case"zoom-out":this.zoomOut();break;case"reset-zoom":this.resetZoom();break;case"dark-mode":document.body.classList.toggle("light-theme");break;case"fullscreen":this.toggleFullscreen();break;case"ai-sidebar":this.toggleAISidebar();break;case"about":this.showAboutDialog();break;case"shortcuts":this.showKeyboardShortcutsDialog();break;case"word-wrap":this.toggleWordWrap();break;case"line-numbers":this.toggleLineNumbers();break;case"minimap":this.toggleMinimap();break}}handleContextAction(e){switch(e){case"cut":document.execCommand("cut");break;case"copy":document.execCommand("copy");break;case"paste":document.execCommand("paste");break}}zoomIn(){this.zoomLevel=Math.min(this.zoomLevel+10,200),this.applyZoom()}zoomOut(){this.zoomLevel=Math.max(this.zoomLevel-10,50),this.applyZoom()}resetZoom(){this.zoomLevel=100,this.applyZoom()}applyZoom(){const e=this.tabs.find(t=>t.id===this.activeTabId);e&&e.textarea&&(e.textarea.style.fontSize=`${this.zoomLevel}%`),this.elements.statusZoom.textContent=`${this.zoomLevel}%`}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}toggleAISidebar(){const e=this.elements.aiSidebar.classList.contains("hidden");this.elements.aiSidebar.classList.toggle("hidden"),e&&(this.ollamaStatus.checked?this.checkServerStatus():(this.ollamaStatus.checked=!0,this.checkOllamaInstallation(),this.loadInstalledModels()))}toggleLineEnding(){const e=this.tabs.find(n=>n.id===this.activeTabId);if(!e)return;e.fileInfo.LineEnding=e.fileInfo.LineEnding==="CRLF"?"LF":"CRLF",e.fileInfo.IsDirty=!0;const t=e.element.querySelector(".tab-dirty");t&&(t.style.display="inline"),this.updateStatusBar()}toggleWordWrap(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=e.textarea.wrap;e.textarea.wrap=t==="off"?"soft":"off",this.showNotification(`Word wrap ${e.textarea.wrap==="off"?"disabled":"enabled"}`)}toggleLineNumbers(){this.showNotification("Line numbers feature coming soon")}toggleMinimap(){this.showNotification("Minimap feature coming soon")}showFindReplaceDialog(e=!1){this.elements.dialogOverlay.classList.remove("hidden"),document.getElementById("dialog-find-replace").classList.remove("hidden"),document.getElementById("find-replace-input").focus();const t=document.getElementById("replace-section");t&&(t.style.display=e?"block":"none"),this.findReplaceMode=e?"replace":"find"}findNext(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value;if(!t)return;const n=e.textarea.value,i=e.textarea.selectionEnd,s=n.indexOf(t,i);if(s!==-1)e.textarea.focus(),e.textarea.setSelectionRange(s,s+t.length),this.updateCursorPosition(e);else{const a=n.indexOf(t,0);a!==-1&&a<i&&(e.textarea.focus(),e.textarea.setSelectionRange(a,a+t.length),this.updateCursorPosition(e))}}findPrevious(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value;if(!t)return;const n=e.textarea.value,i=e.textarea.selectionStart-1,s=n.lastIndexOf(t,i);if(s!==-1)e.textarea.focus(),e.textarea.setSelectionRange(s,s+t.length),this.updateCursorPosition(e);else{const a=n.lastIndexOf(t);a!==-1&&a>i&&(e.textarea.focus(),e.textarea.setSelectionRange(a,a+t.length),this.updateCursorPosition(e))}}replaceOne(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value,n=document.getElementById("replace-input").value;if(!t)return;const i=e.textarea.value,s=e.textarea.selectionStart;if(i.substring(e.textarea.selectionStart,e.textarea.selectionEnd)===t){const l=i.substring(0,e.textarea.selectionStart)+n+i.substring(e.textarea.selectionEnd);e.textarea.value=l,e.textarea.setSelectionRange(s,s+n.length),this.onEditorChange(e)}else this.findNext()}replaceAll(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value,n=document.getElementById("replace-input").value;if(!t)return;const i=e.textarea.value,s=new RegExp(this.escapeRegExp(t),"g"),a=i.replace(s,n);i!==a&&(e.textarea.value=a,this.onEditorChange(e),this.showNotification(`Replaced ${(i.match(s)||[]).length} occurrence(s)`,"success"))}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}showGoToDialog(){this.elements.dialogOverlay.classList.remove("hidden"),document.getElementById("dialog-goto").classList.remove("hidden"),document.getElementById("goto-input").focus()}hideDialogs(){this.elements.dialogOverlay.classList.add("hidden"),document.querySelectorAll(".dialog").forEach(e=>e.classList.add("hidden"))}showNotification(e,t="info"){const n=document.getElementById("notification-toast");n&&n.remove();const i=document.createElement("div");i.id="notification-toast",i.className=`notification ${t}`,i.textContent=e,document.body.appendChild(i),setTimeout(()=>i.classList.add("show"),10),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},3e3)}showConfirmDialog(e,t,n,i=null){this.elements.dialogOverlay.classList.remove("hidden");let s=document.getElementById("dialog-confirm");s||(s=document.createElement("div"),s.id="dialog-confirm",s.className="dialog dialog-confirm hidden",s.innerHTML=`
                <div class="dialog-header" id="confirm-title">Confirm</div>
                <div class="dialog-body" id="confirm-message">Are you sure?</div>
                <div class="dialog-footer">
                    <button id="confirm-yes">Yes</button>
                    <button id="confirm-no">No</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(s)),document.getElementById("confirm-title").textContent=e,document.getElementById("confirm-message").textContent=t,s.classList.remove("hidden");const a=document.getElementById("confirm-yes"),l=document.getElementById("confirm-no"),o=a.cloneNode(!0),c=l.cloneNode(!0);a.parentNode.replaceChild(o,a),l.parentNode.replaceChild(c,l),o.addEventListener("click",()=>{this.hideDialogs(),n&&n()}),c.addEventListener("click",()=>{this.hideDialogs(),i&&i()})}showSaveConfirmDialog(e,t,n,i,s=null){this.elements.dialogOverlay.classList.remove("hidden");let a=document.getElementById("dialog-save-confirm");a||(a=document.createElement("div"),a.id="dialog-save-confirm",a.className="dialog dialog-confirm hidden",a.style.width="400px",a.innerHTML=`
                <div class="dialog-header" id="save-confirm-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">\u{1F4BE}</span>
                    <span>Unsaved Changes</span>
                </div>
                <div class="dialog-body" id="save-confirm-message" style="padding: 20px; text-align: center;">
                    Save changes?
                </div>
                <div class="dialog-footer" style="justify-content: center; gap: 10px; padding: 15px 20px;">
                    <button id="save-confirm-save" class="btn-primary" style="padding: 8px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button id="save-confirm-dontsave" style="padding: 8px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Don't Save</button>
                    <button id="save-confirm-cancel" style="padding: 8px 20px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(a)),document.getElementById("save-confirm-title").innerHTML=`<span style="font-size: 20px;">\u{1F4BE}</span><span>${e}</span>`,document.getElementById("save-confirm-message").textContent=t,a.classList.remove("hidden");const l=document.getElementById("save-confirm-save"),o=document.getElementById("save-confirm-dontsave"),c=document.getElementById("save-confirm-cancel"),d=l.cloneNode(!0),h=o.cloneNode(!0),u=c.cloneNode(!0);l.parentNode.replaceChild(d,l),o.parentNode.replaceChild(h,o),c.parentNode.replaceChild(u,c),d.addEventListener("click",()=>{this.hideDialogs(),n&&n()}),h.addEventListener("click",()=>{this.hideDialogs(),i&&i()}),u.addEventListener("click",()=>{this.hideDialogs(),s&&s()})}showStyledConfirmDialog(e,t,n,i,s,a=null){this.elements.dialogOverlay.classList.remove("hidden");const l="dialog-styled-confirm";let o=document.getElementById(l);o||(o=document.createElement("div"),o.id=l,o.className="dialog dialog-confirm hidden",o.style.width="380px",o.innerHTML=`
                <div class="dialog-header" id="styled-confirm-title" style="display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color);">
                    <span id="styled-confirm-icon" style="font-size: 20px;">\u26A0\uFE0F</span>
                    <span id="styled-confirm-header-text">Confirm</span>
                </div>
                <div class="dialog-body" id="styled-confirm-message" style="padding: 25px 20px; text-align: center; font-size: 14px; line-height: 1.5;">
                    Are you sure?
                </div>
                <div class="dialog-footer" style="justify-content: center; gap: 12px; padding: 15px 20px;">
                    <button id="styled-confirm-yes" class="btn-danger" style="padding: 8px 20px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Delete</button>
                    <button id="styled-confirm-no" style="padding: 8px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(o));const c=n.toLowerCase().includes("delete"),d=c?"\u{1F5D1}\uFE0F":"\u26A0\uFE0F",h=c?"var(--error-color)":"var(--accent-color)";document.getElementById("styled-confirm-icon").textContent=d,document.getElementById("styled-confirm-header-text").textContent=e,document.getElementById("styled-confirm-message").textContent=t;const u=document.getElementById("styled-confirm-yes"),m=document.getElementById("styled-confirm-no");u.textContent=n,u.style.background=h,m.textContent=i,o.classList.remove("hidden");const p=u.cloneNode(!0),f=m.cloneNode(!0);u.parentNode.replaceChild(p,u),m.parentNode.replaceChild(f,m),p.addEventListener("click",()=>{this.hideDialogs(),s&&s()}),f.addEventListener("click",()=>{this.hideDialogs(),a&&a()})}goToLine(){const e=parseInt(document.getElementById("goto-input").value);if(e>0){const t=this.tabs.find(n=>n.id===this.activeTabId);if(t&&t.textarea){const n=t.textarea.value.split(`
`);let i=0;for(let s=0;s<Math.min(e-1,n.length);s++)i+=n[s].length+1;t.textarea.focus(),t.textarea.setSelectionRange(i,i)}}this.hideDialogs()}showContextMenu(e){e.preventDefault();const t=this.elements.contextMenu;t.style.left=`${e.pageX}px`,t.style.top=`${e.pageY}px`,t.classList.remove("hidden")}setupEventListeners(){this.elements.newTabBtn&&this.elements.newTabBtn.addEventListener("click",()=>this.newFile());const e=document.getElementById("close-ai-sidebar");e&&e.addEventListener("click",()=>{this.elements.aiSidebar.classList.add("hidden")}),this.elements.statusLineEnding&&this.elements.statusLineEnding.addEventListener("click",()=>this.toggleLineEnding()),this.elements.statusZoom&&this.elements.statusZoom.addEventListener("click",()=>this.resetZoom());const t=document.getElementById("find-close");t&&t.addEventListener("click",()=>this.hideDialogs());const n=document.getElementById("find-next-btn");n&&n.addEventListener("click",()=>this.findNext());const i=document.getElementById("find-prev-btn");i&&i.addEventListener("click",()=>this.findPrevious());const s=document.getElementById("replace-one-btn");s&&s.addEventListener("click",()=>this.replaceOne());const a=document.getElementById("replace-all-btn");a&&a.addEventListener("click",()=>this.replaceAll());const l=document.getElementById("goto-cancel");l&&l.addEventListener("click",()=>this.hideDialogs());const o=document.getElementById("goto-ok");o&&o.addEventListener("click",()=>this.goToLine())}setupKeyboardShortcuts(){this.shortcuts={new:{key:"n",ctrl:!0,shift:!1,action:()=>this.newFile()},open:{key:"o",ctrl:!0,shift:!1,action:()=>this.openFile()},save:{key:"s",ctrl:!0,shift:!1,action:()=>this.saveTab()},"save-as":{key:"s",ctrl:!0,shift:!0,action:()=>this.saveAs()},find:{key:"f",ctrl:!0,shift:!1,action:()=>this.showFindReplaceDialog(!1)},replace:{key:"h",ctrl:!0,shift:!1,action:()=>this.showFindReplaceDialog(!0)},"go-to":{key:"g",ctrl:!0,shift:!1,action:()=>this.showGoToDialog()},"zoom-in":{key:"+",ctrl:!0,shift:!0,action:()=>this.zoomIn()},"zoom-out":{key:"-",ctrl:!0,shift:!1,action:()=>this.zoomOut()},"reset-zoom":{key:"0",ctrl:!0,shift:!1,action:()=>this.resetZoom()},"word-wrap":{key:"z",ctrl:!0,shift:!1,action:()=>this.toggleWordWrap()},"line-numbers":{key:"l",ctrl:!0,shift:!0,action:()=>this.toggleLineNumbers()},minimap:{key:"m",ctrl:!0,shift:!0,action:()=>this.toggleMinimap()},fullscreen:{key:"F11",ctrl:!1,shift:!1,action:()=>this.toggleFullscreen()},"ai-sidebar":{key:"a",ctrl:!0,shift:!0,action:()=>this.toggleAISidebar()}},document.addEventListener("keydown",e=>{if(e.key==="F11"){e.preventDefault(),this.toggleFullscreen();return}if((e.ctrlKey||e.metaKey)&&!e.altKey){if(e.key==="+"||e.key==="="){e.preventDefault(),this.zoomIn();return}if(e.key==="-"){e.preventDefault(),this.zoomOut();return}if(e.key==="0"){e.preventDefault(),this.resetZoom();return}}for(const[t,n]of Object.entries(this.shortcuts)){const i=e.key.toLowerCase()===n.key.toLowerCase(),s=e.ctrlKey===n.ctrl||e.metaKey===n.ctrl,a=e.shiftKey===n.shift;if(i&&s&&a){if((e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&t!=="save"&&t!=="save-as"&&t!=="open"&&t!=="new")continue;e.preventDefault(),n.action();return}}})}updateStatusBar(){const e=this.tabs.find(t=>t.id===this.activeTabId);!e||(this.elements.statusFile&&(this.elements.statusFile.textContent=e.fileInfo.Name),this.elements.statusEncoding&&(this.elements.statusEncoding.textContent=e.fileInfo.Encoding),this.elements.statusLineEnding&&(this.elements.statusLineEnding.textContent=e.fileInfo.LineEnding),this.elements.statusZoom&&(this.elements.statusZoom.textContent=`${this.zoomLevel}%`),this.updateCursorPosition(e))}getActiveTab(){return this.tabs.find(e=>e.id===this.activeTabId)}showAboutDialog(){this.elements.dialogOverlay.classList.remove("hidden");let e=document.getElementById("dialog-about");e||(e=document.createElement("div"),e.id="dialog-about",e.className="dialog hidden",e.style.width="450px",e.innerHTML=`
                <div class="dialog-header">About Akashic</div>
                <div class="dialog-body" style="text-align: center; padding: 30px;">
                    <img src="./logo.png" alt="Akashic Logo" style="width: 80px; height: 80px; margin-bottom: 20px; border-radius: 8px;">
                    <h2 style="margin-bottom: 10px; color: var(--accent-color);">Akashic Editor</h2>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">v0.1.0</p>
                    <p style="font-size: 13px; line-height: 1.6; margin-bottom: 20px;">
                        Akashic is an AI-enhanced text editor built with Wails and modern web technologies.
                        Designed for developers who want a lightweight yet powerful editing experience.
                    </p>
                </div>
                <div class="dialog-footer" style="justify-content: center;">
                    <button id="about-close" style="padding: 8px 24px;">Close</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(e),document.getElementById("about-close").addEventListener("click",()=>{this.hideDialogs()})),e.classList.remove("hidden")}showKeyboardShortcutsDialog(){this.elements.dialogOverlay.classList.remove("hidden");let e=document.getElementById("dialog-shortcuts");e||(e=document.createElement("div"),e.id="dialog-shortcuts",e.className="dialog hidden",e.style.width="500px",e.style.maxHeight="80vh",e.innerHTML=`
                <div class="dialog-header">Keyboard Shortcuts</div>
                <div class="dialog-body" style="padding: 0; max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th style="text-align: left; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">Action</th>
                                <th style="text-align: left; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">Shortcut</th>
                            </tr>
                        </thead>
                        <tbody id="shortcuts-list">
                        </tbody>
                    </table>
                </div>
                <div class="dialog-footer">
                    <button id="shortcuts-close">Close</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(e),document.getElementById("shortcuts-close").addEventListener("click",()=>{this.hideDialogs()})),this.renderShortcutsList(),e.classList.remove("hidden")}renderShortcutsList(){const e=document.getElementById("shortcuts-list");if(!e)return;e.innerHTML="";const t={new:"New File",open:"Open File",save:"Save","save-as":"Save As",find:"Find",replace:"Replace","go-to":"Go To Line","zoom-in":"Zoom In","zoom-out":"Zoom Out","reset-zoom":"Reset Zoom","word-wrap":"Toggle Word Wrap","line-numbers":"Toggle Line Numbers",minimap:"Toggle Minimap",fullscreen:"Fullscreen","ai-sidebar":"Toggle AI Sidebar"};for(const[n,i]of Object.entries(this.shortcuts)){const s=document.createElement("tr");s.style.borderBottom="1px solid var(--border-color)";const a=[];i.ctrl&&a.push("Ctrl"),i.shift&&a.push("Shift"),a.push(i.key.toUpperCase()),s.innerHTML=`
                <td style="padding: 8px 15px; color: var(--text-primary);">${t[n]||n}</td>
                <td style="padding: 8px 15px;">
                    <kbd style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 12px;">
                        ${a.join("+")}
                    </kbd>
                </td>
            `,e.appendChild(s)}}setupWindowCloseHandler(){window.addEventListener("beforeunload",e=>{const t=this.tabs.filter(n=>n.fileInfo.IsDirty);t.length>0&&(e.preventDefault(),e.returnValue="",this.showSaveConfirmDialog("Unsaved Changes",`You have ${t.length} unsaved file(s). Save before closing?`,async()=>{await Promise.all(t.map(n=>this.saveTab(n))),window.removeEventListener("beforeunload",this),window.close()},()=>{window.removeEventListener("beforeunload",this),window.close()},()=>{}))})}exitApp(){const e=this.tabs.filter(t=>t.fileInfo.IsDirty);e.length>0?this.showSaveConfirmDialog("Unsaved Changes",`You have ${e.length} unsaved file(s). Save before exiting?`,()=>{Promise.all(e.map(t=>this.saveTab(t))).then(()=>{this.quitApplication()})},()=>{this.quitApplication()},()=>{}):this.quitApplication()}quitApplication(){window.go&&window.go.main&&window.go.main.App&&window.go.main.App.Quit?window.go.main.App.Quit():window.close()}async checkOllamaInstallation(){try{const e=await I();this.ollamaStatus=e;const t=document.getElementById("ai-status-indicator"),n=document.getElementById("ai-status-text"),i=document.getElementById("ai-setup-panel");e.installed?(t.className="status-dot online",n.textContent=`Ollama ${e.version}`,i.classList.add("hidden"),await this.loadInstalledModels(),await this.checkServerStatus()):(t.className="status-dot offline",n.textContent="Ollama not installed",i.classList.remove("hidden"))}catch(e){console.error("Failed to check Ollama:",e),this.showNotification("Failed to check Ollama installation","error")}}async loadInstalledModels(){try{const e=await y();this.installedModels=e;const t=document.getElementById("ai-model");t.innerHTML="",e.length===0?t.innerHTML='<option value="">No models installed</option>':(e.forEach(n=>{const i=document.createElement("option");i.value=n.name,i.textContent=`${n.name} (${n.size})`,t.appendChild(i)}),this.selectedModel=e[0].name,t.value=this.selectedModel),t.addEventListener("change",n=>{this.selectedModel=n.target.value})}catch(e){console.error("Failed to load models:",e)}}async checkServerStatus(){try{await y(),this.serverRunning=!0,this.updateServerStatusUI(!0)}catch{this.serverRunning=!1,this.updateServerStatusUI(!1)}}updateServerStatusUI(e){const t=document.getElementById("ai-status-indicator"),n=document.getElementById("ai-status-text"),i=document.getElementById("start-ollama-server");!t||!n||(e?(t.className="status-dot online",n.textContent="Server running",n.style.color="var(--success-color)",i&&i.classList.add("hidden")):(t.className="status-dot offline",n.textContent="Server not running",n.style.color="var(--error-color)",i&&i.classList.remove("hidden")))}async startOllamaServer(){try{this.showNotification("Starting Ollama server...","info"),await M(),this.showNotification("Ollama server started!","success"),this.serverRunning=!0,this.updateServerStatusUI(!0),document.getElementById("ai-chat-container").classList.remove("hidden")}catch(e){console.error("Failed to start server:",e),this.showNotification(e.message||"Failed to start server","error")}}async generateWithAI(){if(!this.selectedModel){this.showNotification("Please select a model first","warning");return}this.currentChatId||await this.createNewChat();const e=document.getElementById("ai-prompt"),t=e.value;if(!t.trim()){this.showNotification("Please enter a prompt","warning");return}const n=document.getElementById("ai-messages"),i=n.querySelector(".ai-welcome");i&&i.remove();const s=document.createElement("div");s.className="ai-message user",s.innerHTML=`<div class="ai-message-content">${this.escapeHtml(t)}</div>`,n.appendChild(s);const a=document.createElement("div");a.className="ai-message assistant",a.innerHTML='<div class="ai-message-content" style="color: var(--text-secondary); font-style: italic;">Generating...</div>',n.appendChild(a),e.value="",n.scrollTop=n.scrollHeight;try{await v(this.currentChatId,"user",t);const o=await S(this.currentChatId,10)+`

User: `+t+`

Assistant:`,c=await B(this.selectedModel,o);a.innerHTML=`<div class="ai-message-content" style="white-space: pre-wrap;">${this.escapeHtml(c)}</div>`,this.lastAIResponse=c,await v(this.currentChatId,"assistant",c);const d=this.chats.find(h=>h.id===this.currentChatId);d&&d.title==="New Chat"&&(await A(this.currentChatId),await this.loadChatHistory(),this.updateChatInfo())}catch(l){console.error("Generation failed:",l),a.innerHTML=`<div class="ai-message-content" style="color: var(--error-color);">Error: ${l.message}</div>`}n.scrollTop=n.scrollHeight}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}insertAIResponse(){if(!this.lastAIResponse){this.showNotification("No AI response to insert","warning");return}const e=this.getActiveTab();if(!e||!e.textarea)return;const t=e.textarea.selectionStart,n=e.textarea.selectionEnd,i=e.textarea.value;e.textarea.value=i.substring(0,t)+this.lastAIResponse+i.substring(n),e.textarea.setSelectionRange(t+this.lastAIResponse.length,t+this.lastAIResponse.length),this.onEditorChange(e),this.showNotification("AI response inserted","success")}replaceWithAIResponse(){if(!this.lastAIResponse){this.showNotification("No AI response to insert","warning");return}const e=this.getActiveTab();if(!e||!e.textarea)return;const t=e.textarea.selectionStart,n=e.textarea.selectionEnd,i=e.textarea.value;e.textarea.value=i.substring(0,t)+this.lastAIResponse+i.substring(n),e.textarea.setSelectionRange(t,t+this.lastAIResponse.length),this.onEditorChange(e),this.showNotification("Text replaced with AI response","success")}setupAIEventListeners(){const e=document.getElementById("check-ollama-again");e&&e.addEventListener("click",()=>this.checkOllamaInstallation());const t=document.getElementById("start-ollama-server");t&&t.addEventListener("click",()=>this.startOllamaServer());const n=document.getElementById("ai-send");n&&n.addEventListener("click",()=>this.generateWithAI());const i=document.getElementById("ai-insert");i&&i.addEventListener("click",()=>this.insertAIResponse());const s=document.getElementById("ai-replace");s&&s.addEventListener("click",()=>this.replaceWithAIResponse()),document.querySelectorAll(".ai-suggestion").forEach(o=>{o.addEventListener("click",()=>{const c=o.dataset.prompt;document.getElementById("ai-prompt").value=c,this.updateSendButtonState(),this.generateWithAI()})});const a=document.getElementById("ai-prompt");a&&(a.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this.generateWithAI())}),a.addEventListener("input",()=>{this.updateSendButtonState()}));const l=document.getElementById("ai-model");l&&l.addEventListener("change",()=>{this.updateSendButtonState()}),this.updateSendButtonState()}updateSendButtonState(){const e=document.getElementById("ai-send"),t=document.getElementById("ai-prompt"),n=document.getElementById("ai-model");if(!e||!t||!n)return;const i=t.value.trim().length>0,s=n.value&&n.value!=="";e.disabled=!(i&&s)}}window.akashic=new O;
