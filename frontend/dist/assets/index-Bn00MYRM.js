(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();function v(d,e,t){return window.go.main.App.AddMessage(d,e,t)}function L(){return window.go.main.App.CheckOllamaInstalled()}function C(d,e){return window.go.main.App.CreateChat(d,e)}function N(){return window.go.main.App.DeleteAllChats()}function B(d){return window.go.main.App.DeleteChat(d)}function y(d,e){return window.go.main.App.ExportAsPDF(d,e)}function k(d,e){return window.go.main.App.GenerateWithOllama(d,e)}function S(d,e){return window.go.main.App.GetChatContext(d,e)}function T(d){return window.go.main.App.GetChatMessages(d)}function A(){return window.go.main.App.GetChats()}function x(){return window.go.main.App.GetInstalledModels()}function w(d){return window.go.main.App.Greet(d)}function E(d,e){return window.go.main.App.OnFileChange(d,e)}function b(){return window.go.main.App.OpenFile()}function F(d){return window.go.main.App.RenameChatFromFirstMessage(d)}function I(d,e,t){return window.go.main.App.SaveFile(d,e,t)}function g(d,e,t){return window.go.main.App.SaveFileAs(d,e,t)}function M(d){return window.go.main.App.SearchChats(d)}function D(){return window.go.main.App.StartOllamaServer()}function H(d,e){return window.go.main.App.UpdateChatTitle(d,e)}console.log("Akashic Editor Starting...");class R{constructor(){this.tabs=[],this.activeTabId=null,this.tabCounter=0,this.zoomLevel=100,this.ollamaStatus={installed:!1,checked:!1},this.installedModels=[],this.selectedModel="",this.serverRunning=!1,this.currentGeneration=null,this.lastAIResponse="",this.currentChatId=null,this.chats=[],this.isLoadingChat=!1,this.showLineNumbers=!1,this.showMinimap=!1,this.lineNumbersEl=null,this.minimapEl=null,this.wordWrap=!0,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.init()):this.init()}async init(){if(console.log("Initializing Akashic Editor..."),this.elements={tabsContainer:document.getElementById("tabs-container"),newTabBtn:document.getElementById("new-tab-btn"),editorContainer:document.getElementById("editor-container"),aiSidebar:document.getElementById("ai-sidebar"),statusFile:document.getElementById("status-file"),statusEncoding:document.getElementById("status-encoding"),statusLineEnding:document.getElementById("status-line-ending"),statusPosition:document.getElementById("status-position"),statusZoom:document.getElementById("status-zoom"),contextMenu:document.getElementById("context-menu"),dialogOverlay:document.getElementById("dialog-overlay"),chatHistoryPanel:document.getElementById("chat-history-panel"),chatList:document.getElementById("chat-list"),chatSearch:document.getElementById("chat-search"),currentChatTitle:document.getElementById("current-chat-title"),chatInfo:document.getElementById("chat-info")},!this.elements.editorContainer){console.error("Editor container not found!"),document.body.innerHTML='<div style="color: red; padding: 20px;">Error: Editor container not found</div>';return}if(this.setupMenus(),this.setupKeyboardShortcuts(),this.setupEventListeners(),this.setupAIEventListeners(),this.setupChatHistoryListeners(),this.createNewTab(),w)try{const e=await w("Developer");console.log("Wails connected:",e)}catch(e){console.warn("Wails greeting failed:",e)}await this.loadChatHistory(),console.log("Editor initialized successfully")}async loadChatHistory(){try{this.chats=await A(),this.renderChatList()}catch(e){console.error("Failed to load chat history:",e)}}renderChatList(){if(this.elements.chatList){if(this.elements.chatList.innerHTML="",this.chats.length===0){this.elements.chatList.innerHTML=`
                <div class="chat-empty">
                    <p>No chats yet</p>
                    <span>Start a new conversation</span>
                </div>
            `;return}this.chats.forEach(e=>{const t=document.createElement("div");t.className="chat-item",t.dataset.chatId=e.id,e.id===this.currentChatId&&t.classList.add("active");const i=new Date(e.updatedAt),n=i.toLocaleDateString()+" "+i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});t.innerHTML=`
                <div class="chat-item-content">
                    <div class="chat-item-title">${this.escapeHtml(e.title)}</div>
                    <div class="chat-item-meta">
                        <span class="chat-item-model">${e.modelName}</span>
                        <span class="chat-item-time">${n}</span>
                    </div>
                </div>
                <button class="chat-item-delete" title="Delete chat">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            `,t.querySelector(".chat-item-content").addEventListener("click",()=>{this.loadChat(e.id)}),t.querySelector(".chat-item-delete").addEventListener("click",s=>{s.stopPropagation(),this.deleteChat(e.id)}),this.elements.chatList.appendChild(t)})}}async createNewChat(){try{const t=await C("New Chat",this.selectedModel||"default");this.currentChatId=t.id,this.chats.unshift(t);const i=document.getElementById("ai-messages");i.innerHTML=`
                <div class="ai-welcome">
                    <div class="ai-welcome-icon">ü§ñ</div>
                    <h3>How can I help you today?</h3>
                    <p>I can help you write, edit, explain code, summarize text, and more.</p>
                    <div class="ai-suggestions">
                        <button class="ai-suggestion" data-prompt="Explain this code">üí° Explain code</button>
                        <button class="ai-suggestion" data-prompt="Rewrite this to be more professional">‚úçÔ∏è Rewrite professionally</button>
                        <button class="ai-suggestion" data-prompt="Summarize this text">üìù Summarize</button>
                        <button class="ai-suggestion" data-prompt="Fix grammar and spelling">üîß Fix grammar</button>
                    </div>
                </div>
            `,i.querySelectorAll(".ai-suggestion").forEach(n=>{n.addEventListener("click",()=>{const s=n.dataset.prompt;document.getElementById("ai-prompt").value=s,this.generateWithAI()})}),this.renderChatList(),this.updateChatInfo()}catch(e){console.error("Failed to create chat:",e),this.showNotification("Failed to create chat","error")}}async loadChat(e){if(!this.isLoadingChat){this.isLoadingChat=!0;try{this.currentChatId=e;const t=await T(e),i=document.getElementById("ai-messages");i.innerHTML="",t.length===0?i.innerHTML=`
                    <div class="ai-welcome">
                        <div class="ai-welcome-icon">ü§ñ</div>
                        <h3>How can I help you today?</h3>
                        <p>I can help you write, edit, explain code, summarize text, and more.</p>
                    </div>
                `:(t.forEach(s=>{const a=document.createElement("div");a.className=`ai-message ${s.role}`,a.innerHTML=`<div class="ai-message-content">${this.escapeHtml(s.content)}</div>`,i.appendChild(a)}),i.scrollTop=i.scrollHeight);const n=this.chats.find(s=>s.id===e);n&&(this.selectedModel=n.modelName,document.getElementById("ai-model").value=n.modelName),this.renderChatList(),this.updateChatInfo()}catch(t){console.error("Failed to load chat:",t),this.showNotification("Failed to load chat","error")}finally{this.isLoadingChat=!1}}}async deleteChat(e){const t=this.chats.find(n=>n.id===e),i=t?t.title:"this chat";this.showStyledConfirmDialog("Delete Chat",`Are you sure you want to delete "${i}"?`,"Delete","Cancel",async()=>{try{if(await B(e),this.chats=this.chats.filter(n=>n.id!==e),this.currentChatId===e){this.currentChatId=null;const n=document.getElementById("ai-messages");n.innerHTML=`
                            <div class="ai-welcome">
                                <div class="ai-welcome-icon">ü§ñ</div>
                                <h3>How can I help you today?</h3>
                            </div>
                        `,this.updateChatInfo()}this.renderChatList(),this.showNotification("Chat deleted","success")}catch(n){console.error("Failed to delete chat:",n),this.showNotification("Failed to delete chat","error")}})}async clearAllChats(){this.showStyledConfirmDialog("Clear All Chats",`Are you sure you want to delete ALL ${this.chats.length} chat(s)? This action cannot be undone.`,"Delete All","Cancel",async()=>{try{await N(),this.chats=[],this.currentChatId=null;const e=document.getElementById("ai-messages");e.innerHTML=`
                        <div class="ai-welcome">
                            <div class="ai-welcome-icon">ü§ñ</div>
                            <h3>How can I help you today?</h3>
                        </div>
                    `,this.renderChatList(),this.updateChatInfo(),this.showNotification("All chats cleared","success")}catch(e){console.error("Failed to clear chats:",e),this.showNotification("Failed to clear chats","error")}})}async searchChats(e){if(!e.trim()){await this.loadChatHistory();return}try{this.chats=await M(e),this.renderChatList()}catch(t){console.error("Failed to search chats:",t)}}async renameCurrentChat(){if(!this.currentChatId)return;const e=this.chats.find(t=>t.id===this.currentChatId);e&&this.showRenameChatDialog(e.title,async t=>{if(!(!t||t===e.title))try{await H(this.currentChatId,t),e.title=t,this.renderChatList(),this.updateChatInfo(),this.showNotification("Chat renamed","success")}catch(i){console.error("Failed to rename chat:",i),this.showNotification("Failed to rename chat","error")}})}showRenameChatDialog(e,t){this.elements.dialogOverlay.classList.remove("hidden");const i="dialog-rename-chat";let n=document.getElementById(i);n||(n=document.createElement("div"),n.id=i,n.className="dialog hidden",n.style.width="350px",n.innerHTML=`
                <div class="dialog-header" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">‚úèÔ∏è</span>
                    <span>Rename Chat</span>
                </div>
                <div class="dialog-body" style="padding: 20px;">
                    <input type="text" id="rename-chat-input" placeholder="Enter chat name..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;">
                </div>
                <div class="dialog-footer" style="justify-content: flex-end; gap: 10px; padding: 15px 20px;">
                    <button id="rename-chat-cancel" style="padding: 6px 16px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button id="rename-chat-save" style="padding: 6px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(n));const s=document.getElementById("rename-chat-input");s.value=e,n.classList.remove("hidden"),setTimeout(()=>{s.focus(),s.select()},10);const a=document.getElementById("rename-chat-save"),r=document.getElementById("rename-chat-cancel"),o=a.cloneNode(!0),l=r.cloneNode(!0);a.parentNode.replaceChild(o,a),r.parentNode.replaceChild(l,r);const h=()=>{this.hideDialogs(),n.classList.add("hidden")};o.addEventListener("click",()=>{const c=s.value.trim();h(),t&&t(c)}),l.addEventListener("click",()=>{h()}),s.addEventListener("keydown",c=>{if(c.key==="Enter"){const m=s.value.trim();h(),t&&t(m)}else c.key==="Escape"&&h()})}updateChatInfo(){if(!(!this.elements.chatInfo||!this.elements.currentChatTitle))if(this.currentChatId){const e=this.chats.find(t=>t.id===this.currentChatId);e&&(this.elements.currentChatTitle.textContent=e.title,this.elements.chatInfo.classList.remove("hidden"))}else this.elements.chatInfo.classList.add("hidden")}setupChatHistoryListeners(){const e=document.getElementById("new-chat-btn");e&&e.addEventListener("click",()=>this.createNewChat());const t=document.getElementById("clear-all-chats");t&&t.addEventListener("click",()=>this.clearAllChats()),this.elements.chatSearch&&this.elements.chatSearch.addEventListener("input",n=>{this.searchChats(n.target.value)});const i=document.getElementById("rename-chat-btn");i&&i.addEventListener("click",()=>this.renameCurrentChat())}createNewTab(e=null,t=""){const i=`tab-${++this.tabCounter}`;console.log("Creating new tab:",i);const n={id:i,fileInfo:e||{Path:"",Name:"Untitled",Encoding:"UTF-8",LineEnding:"CRLF",IsDirty:!1,IsNewFile:!0},content:t||"",textarea:null};return this.tabs.push(n),this.renderTab(n),this.switchToTab(i),n}renderTab(e){const t=document.createElement("div");t.className="tab",t.dataset.tabId=e.id,t.innerHTML=`
            <span class="tab-dirty" style="display: none;">‚óè</span>
            <span class="tab-name">${e.fileInfo.Name}</span>
            <span class="tab-close">√ó</span>
        `,t.addEventListener("click",i=>{i.target.classList.contains("tab-close")?this.closeTab(e.id):this.switchToTab(e.id)}),this.elements.tabsContainer.appendChild(t),e.element=t}switchToTab(e){if(console.log("Switching to tab:",e),this.activeTabId){const i=this.tabs.find(n=>n.id===this.activeTabId);i&&i.textarea&&(i.content=i.textarea.value,i.element.classList.remove("active"))}this.activeTabId=e;const t=this.tabs.find(i=>i.id===e);t&&(t.element.classList.add("active"),this.elements.editorContainer.innerHTML="",this.createTextareaEditor(t),this.updateStatusBar())}createTextareaEditor(e){console.log("Creating textarea editor for:",e.id);const t=document.createElement("div");t.className="editor-wrapper";const i=document.createElement("textarea");i.className="editor-textarea",i.value=e.content,i.spellcheck=!1,i.wrap=this.wordWrap?"soft":"off",i.style.fontSize=`${this.zoomLevel}%`,i.addEventListener("input",()=>{this.onEditorChange(e),this.showLineNumbers&&this.updateLineNumbers(e),this.showMinimap&&this.updateMinimap(e)}),i.addEventListener("click",()=>{this.updateCursorPosition(e),this.showLineNumbers&&this.updateLineNumbers(e)}),i.addEventListener("keyup",()=>{this.updateCursorPosition(e),this.showLineNumbers&&this.updateLineNumbers(e)}),i.addEventListener("scroll",()=>{this.showLineNumbers&&this.updateLineNumbers(e),this.showMinimap&&this.updateMinimap(e)}),i.addEventListener("keydown",n=>{if(n.key==="Tab"){n.preventDefault();const s=i.selectionStart,a=i.selectionEnd;i.value=i.value.substring(0,s)+"	"+i.value.substring(a),i.selectionStart=i.selectionEnd=s+1,this.onEditorChange(e)}}),t.appendChild(i),this.elements.editorContainer.appendChild(t),e.textarea=i,e.wrapper=t,(this.showLineNumbers||this.showMinimap)&&this.updateEditorView(e),setTimeout(()=>{i.focus(),console.log("Textarea focused")},10)}onEditorChange(e){if(e.content=e.textarea.value,!e.fileInfo.IsDirty){e.fileInfo.IsDirty=!0;const t=e.element.querySelector(".tab-dirty");t&&(t.style.display="inline")}if(E)try{E(e.fileInfo.Path,!0)}catch{}}updateCursorPosition(e){if(!e.textarea)return;const t=e.textarea.value,i=e.textarea.selectionStart,n=t.substring(0,i).split(`
`),s=n.length,a=n[n.length-1].length+1;this.elements.statusPosition.textContent=`Ln ${s}, Col ${a}`}closeTab(e){const t=this.tabs.findIndex(n=>n.id===e);if(t===-1)return;const i=this.tabs[t];if(i.fileInfo.IsDirty){this.showSaveConfirmDialog("Unsaved Changes",`Save changes to ${i.fileInfo.Name}?`,()=>this.saveAndCloseTab(i,e),()=>this.forceCloseTab(e));return}this.forceCloseTab(e)}async saveAndCloseTab(e,t){await this.saveTab(e),this.forceCloseTab(t)}forceCloseTab(e){const t=this.tabs.findIndex(n=>n.id===e);if(t===-1)return;if(this.tabs[t].element.remove(),this.tabs.splice(t,1),this.activeTabId===e)if(this.tabs.length>0){const n=Math.min(t,this.tabs.length-1);this.switchToTab(this.tabs[n].id)}else this.activeTabId=null,this.createNewTab()}async newFile(){console.log("Creating new file"),this.createNewTab()}async openFile(){if(console.log("Opening file..."),!b){this.showNotification("File dialog not available","error");return}try{const e=await b();if(console.log("OpenFile result:",e),!e){console.log("No file selected");return}const t=e.fileInfo,i=e.content||"";if(t){console.log("File opened:",t.name);const n={Path:t.path||"",Name:t.name||"Untitled",Encoding:t.encoding||"UTF-8",LineEnding:t.lineEnding||"CRLF",IsDirty:t.isDirty||!1,IsNewFile:t.isNewFile||!1};this.createNewTab(n,i)}}catch(e){console.error("Failed to open file:",e),this.showNotification("Failed to open file: "+(e.message||e),"error")}}async saveTab(e=null){if(e||(e=this.tabs.find(i=>i.id===this.activeTabId)),!e||!e.textarea)return;const t=e.textarea.value;if(console.log("Saving file:",e.fileInfo.Name),!I||!g){this.showNotification("Save not available","error");return}try{let i;if(e.fileInfo.IsNewFile||!e.fileInfo.Path?i=await g(e.fileInfo.Name,t,e.fileInfo.LineEnding):i=await I(e.fileInfo.Path,t,e.fileInfo.LineEnding),i){const n={Path:i.path||i.Path||"",Name:i.name||i.Name||"Untitled",Encoding:i.encoding||i.Encoding||"UTF-8",LineEnding:i.lineEnding||i.LineEnding||"CRLF",IsDirty:!1,IsNewFile:i.isNewFile||i.IsNewFile||!1};e.fileInfo=n;const s=e.element.querySelector(".tab-name"),a=e.element.querySelector(".tab-dirty");s&&(s.textContent=n.Name),a&&(a.style.display="none"),this.updateStatusBar(),this.showNotification("File saved: "+n.Name,"success"),console.log("File saved:",n.Name)}}catch(i){console.error("Failed to save:",i),this.showNotification("Failed to save file: "+(i.message||i),"error")}}async saveAs(){const e=this.tabs.find(i=>i.id===this.activeTabId);if(!e||!e.textarea)return;const t=e.textarea.value;if(!g){this.showNotification("Save As not available","error");return}try{const i=await g(e.fileInfo.Name,t,e.fileInfo.LineEnding);if(i){const n={Path:i.path||i.Path||"",Name:i.name||i.Name||"Untitled",Encoding:i.encoding||i.Encoding||"UTF-8",LineEnding:i.lineEnding||i.LineEnding||"CRLF",IsDirty:!1,IsNewFile:i.isNewFile||i.IsNewFile||!1};e.fileInfo=n;const s=e.element.querySelector(".tab-name"),a=e.element.querySelector(".tab-dirty");s&&(s.textContent=n.Name),a&&(a.style.display="none"),this.updateStatusBar(),this.showNotification("File saved: "+n.Name,"success")}}catch(i){console.error("Failed to save:",i),this.showNotification("Failed to save file: "+(i.message||i),"error")}}setupMenus(){console.log("Setting up menus..."),document.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=e.dataset.menu;this.toggleMenu(i)})}),document.querySelectorAll(".dropdown").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=t.target.closest(".menu-option");if(i){const n=i.dataset.action;console.log("Menu action:",n),this.handleMenuAction(n),this.hideAllMenus()}})}),document.querySelectorAll(".context-item").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=e.dataset.action;this.handleContextAction(i),this.elements.contextMenu.classList.add("hidden")})}),document.addEventListener("click",e=>{!e.target.closest("#menu-bar")&&!e.target.closest(".dropdown")&&this.hideAllMenus(),this.elements.contextMenu.classList.add("hidden")})}toggleMenu(e){const t=document.getElementById(`menu-${e}`),i=document.querySelector(`[data-menu="${e}"]`);if(!t||!i){console.warn("Menu not found:",e);return}const n=t.classList.contains("show");if(this.hideAllMenus(),!n){t.classList.add("show");const s=i.getBoundingClientRect();t.style.left=`${s.left}px`,t.style.top=`${s.bottom}px`}}hideAllMenus(){document.querySelectorAll(".dropdown").forEach(e=>e.classList.remove("show"))}handleMenuAction(e){switch(console.log("Handling menu action:",e),e){case"new":this.newFile();break;case"open":this.openFile();break;case"save":this.saveTab();break;case"save-as":this.saveAs();break;case"exit":this.exitApp();break;case"undo":document.execCommand("undo");break;case"redo":document.execCommand("redo");break;case"cut":document.execCommand("cut");break;case"copy":document.execCommand("copy");break;case"paste":document.execCommand("paste");break;case"find":this.showFindReplaceDialog(!1);break;case"replace":this.showFindReplaceDialog(!0);break;case"go-to":this.showGoToDialog();break;case"zoom-in":this.zoomIn();break;case"zoom-out":this.zoomOut();break;case"reset-zoom":this.resetZoom();break;case"dark-mode":document.body.classList.toggle("light-theme");break;case"fullscreen":this.toggleFullscreen();break;case"ai-sidebar":this.toggleAISidebar();break;case"about":this.showAboutDialog();break;case"shortcuts":this.showKeyboardShortcutsDialog();break;case"word-wrap":this.toggleWordWrap();break;case"line-numbers":this.toggleLineNumbers();break;case"minimap":this.toggleMinimap();break}}handleContextAction(e){switch(e){case"cut":document.execCommand("cut");break;case"copy":document.execCommand("copy");break;case"paste":document.execCommand("paste");break}}zoomIn(){this.zoomLevel=Math.min(this.zoomLevel+10,200),this.applyZoom()}zoomOut(){this.zoomLevel=Math.max(this.zoomLevel-10,50),this.applyZoom()}resetZoom(){this.zoomLevel=100,this.applyZoom()}applyZoom(){const e=this.tabs.find(t=>t.id===this.activeTabId);e&&e.textarea&&(e.textarea.style.fontSize=`${this.zoomLevel}%`),this.elements.statusZoom.textContent=`${this.zoomLevel}%`}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}toggleAISidebar(){const e=this.elements.aiSidebar.classList.contains("hidden");this.elements.aiSidebar.classList.toggle("hidden"),e&&(this.ollamaStatus.checked?this.checkServerStatus():(this.ollamaStatus.checked=!0,this.checkOllamaInstallation(),this.loadInstalledModels()))}toggleLineEnding(){const e=this.tabs.find(i=>i.id===this.activeTabId);if(!e)return;e.fileInfo.LineEnding=e.fileInfo.LineEnding==="CRLF"?"LF":"CRLF",e.fileInfo.IsDirty=!0;const t=e.element.querySelector(".tab-dirty");t&&(t.style.display="inline"),this.updateStatusBar()}toggleWordWrap(){this.wordWrap=!this.wordWrap,this.tabs.forEach(e=>{e.textarea&&(e.textarea.wrap=this.wordWrap?"soft":"off")}),this.showNotification(`Word wrap ${this.wordWrap?"enabled":"disabled"}`)}toggleLineNumbers(){this.showLineNumbers=!this.showLineNumbers;const e=this.getActiveTab();e&&this.updateEditorView(e),this.showNotification(`Line numbers ${this.showLineNumbers?"enabled":"disabled"}`)}toggleMinimap(){this.showMinimap=!this.showMinimap;const e=this.getActiveTab();e&&this.updateEditorView(e),this.showNotification(`Minimap ${this.showMinimap?"enabled":"disabled"}`)}updateEditorView(e){if(!e||!e.textarea)return;let t=e.textarea.parentElement;if((!t||!t.classList.contains("editor-wrapper"))&&(t=document.createElement("div"),t.className="editor-wrapper",e.textarea.parentNode.insertBefore(t,e.textarea),t.appendChild(e.textarea)),this.showLineNumbers?((!this.lineNumbersEl||this.lineNumbersEl.parentNode!==t)&&(this.lineNumbersEl=document.createElement("div"),this.lineNumbersEl.className="line-numbers",t.insertBefore(this.lineNumbersEl,e.textarea)),this.updateLineNumbers(e)):this.lineNumbersEl&&this.lineNumbersEl.parentNode===t&&(this.lineNumbersEl.remove(),this.lineNumbersEl=null),this.showMinimap){if(!this.minimapEl||this.minimapEl.parentNode!==t){this.minimapEl=document.createElement("div"),this.minimapEl.className="minimap-container";const i=document.createElement("div");i.className="minimap-content",this.minimapEl.appendChild(i),t.appendChild(this.minimapEl)}this.updateMinimap(e)}else this.minimapEl&&this.minimapEl.parentNode===t&&(this.minimapEl.remove(),this.minimapEl=null);e.textarea.removeEventListener("scroll",e._scrollHandler),e.textarea.removeEventListener("input",e._inputHandler),e._scrollHandler=()=>{this.showLineNumbers&&this.updateLineNumbers(e),this.showMinimap&&this.updateMinimap(e)},e._inputHandler=()=>{this.showLineNumbers&&this.updateLineNumbers(e),this.showMinimap&&this.updateMinimap(e)},e.textarea.addEventListener("scroll",e._scrollHandler),e.textarea.addEventListener("input",e._inputHandler)}updateLineNumbers(e){if(!this.lineNumbersEl||!e.textarea)return;const t=e.textarea.value.split(`
`),i=e.textarea.scrollTop,n=21,s=Math.floor(i/n),a=Math.ceil(e.textarea.clientHeight/n);let r="";const o=this.getCurrentLineNumber(e);for(let l=s;l<Math.min(s+a+1,t.length);l++){const h=l+1===o;r+=`<div class="line-number${h?" active":""}">${l+1}</div>`}this.lineNumbersEl.innerHTML=r,this.lineNumbersEl.style.paddingTop="10px"}getCurrentLineNumber(e){return e.textarea?e.textarea.value.substring(0,e.textarea.selectionStart).split(`
`).length:1}updateMinimap(e){if(!this.minimapEl||!e.textarea)return;const t=this.minimapEl.querySelector(".minimap-content");if(!t)return;const i=e.textarea.value,n=5e3,s=i.length>n?i.substring(0,n)+"...":i;t.textContent=s;const a=e.textarea.scrollTop/(e.textarea.scrollHeight-e.textarea.clientHeight||1),r=e.textarea.clientHeight/e.textarea.scrollHeight*100;let o=this.minimapEl.querySelector(".minimap-viewport");o||(o=document.createElement("div"),o.className="minimap-viewport",this.minimapEl.appendChild(o)),o.style.top=`${a*(100-r)}%`,o.style.height=`${Math.max(r,10)}%`}showFindReplaceDialog(e=!1){this.elements.dialogOverlay.classList.remove("hidden");let t=document.getElementById("dialog-find-replace");t||(t=document.createElement("div"),t.id="dialog-find-replace",t.className="dialog hidden",t.innerHTML=`
                <div class="dialog-header">
                    <span>${e?"Find and Replace":"Find"}</span>
                    <button id="find-close" style="background: none; border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer;">√ó</button>
                </div>
                <div class="dialog-body">
                    <div class="find-replace-row">
                        <label>Find:</label>
                        <input type="text" id="find-replace-input" placeholder="Search text...">
                    </div>
                    <div class="find-replace-row" id="replace-row" style="display: none;">
                        <label>Replace:</label>
                        <input type="text" id="replace-input" placeholder="Replace with...">
                    </div>
                    <div class="find-replace-options">
                        <label><input type="checkbox" id="find-case-sensitive"> Case sensitive</label>
                        <label><input type="checkbox" id="find-regex"> Regex</label>
                        <label><input type="checkbox" id="find-whole-word"> Whole word</label>
                    </div>
                    <div class="find-replace-stats" id="find-stats"></div>
                    <div class="find-replace-buttons">
                        <button id="find-prev-btn" class="primary">Previous</button>
                        <button id="find-next-btn" class="primary">Next</button>
                        <button id="replace-one-btn" style="display: none;">Replace</button>
                        <button id="replace-all-btn" style="display: none;">Replace All</button>
                    </div>
                </div>
            `,this.elements.dialogOverlay.appendChild(t),document.getElementById("find-close").addEventListener("click",()=>this.hideDialogs()),document.getElementById("find-next-btn").addEventListener("click",()=>this.findNext()),document.getElementById("find-prev-btn").addEventListener("click",()=>this.findPrevious()),document.getElementById("replace-one-btn").addEventListener("click",()=>this.replaceOne()),document.getElementById("replace-all-btn").addEventListener("click",()=>this.replaceAll()),document.getElementById("find-replace-input").addEventListener("keydown",r=>{r.key==="Enter"?(r.preventDefault(),r.shiftKey?this.findPrevious():this.findNext()):r.key==="Escape"&&this.hideDialogs()}),document.getElementById("find-replace-input").addEventListener("input",()=>this.updateFindStats()));const i=document.getElementById("replace-row"),n=document.getElementById("replace-one-btn"),s=document.getElementById("replace-all-btn");i&&(i.style.display=e?"flex":"none"),n&&(n.style.display=e?"block":"none"),s&&(s.style.display=e?"block":"none");const a=t.querySelector(".dialog-header span");a&&(a.textContent=e?"Find and Replace":"Find"),t.classList.remove("hidden"),document.getElementById("find-replace-input").focus(),document.getElementById("find-replace-input").select(),this.findReplaceMode=e?"replace":"find",this.updateFindStats()}updateFindStats(){const e=document.getElementById("find-stats");if(!e)return;const t=this.getActiveTab();if(!t||!t.textarea){e.textContent="";return}const i=document.getElementById("find-replace-input").value;if(!i){e.textContent="";return}const n=document.getElementById("find-regex")?.checked,s=document.getElementById("find-case-sensitive")?.checked,a=document.getElementById("find-whole-word")?.checked;let r;try{let l=i;n?l=i:l=this.escapeRegExp(i),a&&(l="\\b"+l+"\\b");const h=s?"g":"gi";r=new RegExp(l,h)}catch{e.textContent="Invalid regex pattern";return}const o=(t.textarea.value.match(r)||[]).length;e.textContent=o>0?`${o} match${o!==1?"es":""} found`:"No matches found"}findNext(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value;if(!t)return;const i=document.getElementById("find-regex")?.checked,n=document.getElementById("find-case-sensitive")?.checked,s=document.getElementById("find-whole-word")?.checked;let a=t;i||(a=this.escapeRegExp(t)),s&&(a="\\b"+a+"\\b");const r=n?"g":"gi";let o;try{o=new RegExp(a,r)}catch{this.showNotification("Invalid search pattern","error");return}const l=e.textarea.value,h=e.textarea.selectionEnd;let c;o.lastIndex=h,c=o.exec(l),c||(o.lastIndex=0,c=o.exec(l)),c&&(e.textarea.focus(),e.textarea.setSelectionRange(c.index,c.index+c[0].length),this.updateCursorPosition(e),this.updateFindStats())}findPrevious(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value;if(!t)return;const i=document.getElementById("find-regex")?.checked,n=document.getElementById("find-case-sensitive")?.checked,s=document.getElementById("find-whole-word")?.checked;let a=t;i||(a=this.escapeRegExp(t)),s&&(a="\\b"+a+"\\b");const r=n?"g":"gi";let o;try{o=new RegExp(a,r)}catch{this.showNotification("Invalid search pattern","error");return}const l=e.textarea.value,h=e.textarea.selectionStart;let c=null,m;for(o.lastIndex=0;(m=o.exec(l))!==null&&!(m.index>=h);)c=m;if(!c)for(;(m=o.exec(l))!==null;)c=m;c&&(e.textarea.focus(),e.textarea.setSelectionRange(c.index,c.index+c[0].length),this.updateCursorPosition(e),this.updateFindStats())}replaceOne(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value,i=document.getElementById("replace-input").value;if(!t)return;const n=document.getElementById("find-regex")?.checked,s=document.getElementById("find-case-sensitive")?.checked,a=document.getElementById("find-whole-word")?.checked;let r=t;n||(r=this.escapeRegExp(t)),a&&(r="\\b"+r+"\\b");const o=s?"g":"gi";let l;try{l=new RegExp(r,o)}catch{this.showNotification("Invalid search pattern","error");return}const h=e.textarea.value,c=e.textarea.selectionStart,m=h.substring(e.textarea.selectionStart,e.textarea.selectionEnd),u=l.test(m);if(l.lastIndex=0,u){const p=h.substring(0,e.textarea.selectionStart)+i+h.substring(e.textarea.selectionEnd);e.textarea.value=p,e.textarea.setSelectionRange(c,c+i.length),this.onEditorChange(e),this.updateFindStats()}else this.findNext()}replaceAll(){const e=this.getActiveTab();if(!e||!e.textarea)return;const t=document.getElementById("find-replace-input").value,i=document.getElementById("replace-input").value;if(!t)return;const n=document.getElementById("find-regex")?.checked,s=document.getElementById("find-case-sensitive")?.checked,a=document.getElementById("find-whole-word")?.checked;let r=t;n||(r=this.escapeRegExp(t)),a&&(r="\\b"+r+"\\b");const o=s?"g":"gi";let l;try{l=new RegExp(r,o)}catch{this.showNotification("Invalid search pattern","error");return}const h=e.textarea.value,c=(h.match(l)||[]).length,m=h.replace(l,i);h!==m&&(e.textarea.value=m,this.onEditorChange(e),this.showNotification(`Replaced ${c} occurrence(s)`,"success"),this.updateFindStats())}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}showGoToDialog(){this.elements.dialogOverlay.classList.remove("hidden"),document.getElementById("dialog-goto").classList.remove("hidden"),document.getElementById("goto-input").focus()}hideDialogs(){this.elements.dialogOverlay.classList.add("hidden"),document.querySelectorAll(".dialog").forEach(e=>e.classList.add("hidden"))}showNotification(e,t="info"){const i=document.getElementById("notification-toast");i&&i.remove();const n=document.createElement("div");n.id="notification-toast",n.className=`notification ${t}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},3e3)}showConfirmDialog(e,t,i,n=null){this.elements.dialogOverlay.classList.remove("hidden");let s=document.getElementById("dialog-confirm");s||(s=document.createElement("div"),s.id="dialog-confirm",s.className="dialog dialog-confirm hidden",s.innerHTML=`
                <div class="dialog-header" id="confirm-title">Confirm</div>
                <div class="dialog-body" id="confirm-message">Are you sure?</div>
                <div class="dialog-footer">
                    <button id="confirm-yes">Yes</button>
                    <button id="confirm-no">No</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(s)),document.getElementById("confirm-title").textContent=e,document.getElementById("confirm-message").textContent=t,s.classList.remove("hidden");const a=document.getElementById("confirm-yes"),r=document.getElementById("confirm-no"),o=a.cloneNode(!0),l=r.cloneNode(!0);a.parentNode.replaceChild(o,a),r.parentNode.replaceChild(l,r),o.addEventListener("click",()=>{this.hideDialogs(),i&&i()}),l.addEventListener("click",()=>{this.hideDialogs(),n&&n()})}showSaveConfirmDialog(e,t,i,n,s=null){this.elements.dialogOverlay.classList.remove("hidden");let a=document.getElementById("dialog-save-confirm");a||(a=document.createElement("div"),a.id="dialog-save-confirm",a.className="dialog dialog-confirm hidden",a.style.width="400px",a.innerHTML=`
                <div class="dialog-header" id="save-confirm-title" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">üíæ</span>
                    <span>Unsaved Changes</span>
                </div>
                <div class="dialog-body" id="save-confirm-message" style="padding: 20px; text-align: center;">
                    Save changes?
                </div>
                <div class="dialog-footer" style="justify-content: center; gap: 10px; padding: 15px 20px;">
                    <button id="save-confirm-save" class="btn-primary" style="padding: 8px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button id="save-confirm-dontsave" style="padding: 8px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Don't Save</button>
                    <button id="save-confirm-cancel" style="padding: 8px 20px; background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(a)),document.getElementById("save-confirm-title").innerHTML=`<span style="font-size: 20px;">üíæ</span><span>${e}</span>`,document.getElementById("save-confirm-message").textContent=t,a.classList.remove("hidden");const r=document.getElementById("save-confirm-save"),o=document.getElementById("save-confirm-dontsave"),l=document.getElementById("save-confirm-cancel"),h=r.cloneNode(!0),c=o.cloneNode(!0),m=l.cloneNode(!0);r.parentNode.replaceChild(h,r),o.parentNode.replaceChild(c,o),l.parentNode.replaceChild(m,l),h.addEventListener("click",()=>{this.hideDialogs(),i&&i()}),c.addEventListener("click",()=>{this.hideDialogs(),n&&n()}),m.addEventListener("click",()=>{this.hideDialogs(),s&&s()})}showStyledConfirmDialog(e,t,i,n,s,a=null){this.elements.dialogOverlay.classList.remove("hidden");const r="dialog-styled-confirm";let o=document.getElementById(r);o||(o=document.createElement("div"),o.id=r,o.className="dialog dialog-confirm hidden",o.style.width="380px",o.innerHTML=`
                <div class="dialog-header" id="styled-confirm-title" style="display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color);">
                    <span id="styled-confirm-icon" style="font-size: 20px;">‚ö†Ô∏è</span>
                    <span id="styled-confirm-header-text">Confirm</span>
                </div>
                <div class="dialog-body" id="styled-confirm-message" style="padding: 25px 20px; text-align: center; font-size: 14px; line-height: 1.5;">
                    Are you sure?
                </div>
                <div class="dialog-footer" style="justify-content: center; gap: 12px; padding: 15px 20px;">
                    <button id="styled-confirm-yes" class="btn-danger" style="padding: 8px 20px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Delete</button>
                    <button id="styled-confirm-no" style="padding: 8px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(o));const l=i.toLowerCase().includes("delete"),h=l?"üóëÔ∏è":"‚ö†Ô∏è",c=l?"var(--error-color)":"var(--accent-color)";document.getElementById("styled-confirm-icon").textContent=h,document.getElementById("styled-confirm-header-text").textContent=e,document.getElementById("styled-confirm-message").textContent=t;const m=document.getElementById("styled-confirm-yes"),u=document.getElementById("styled-confirm-no");m.textContent=i,m.style.background=c,u.textContent=n,o.classList.remove("hidden");const p=m.cloneNode(!0),f=u.cloneNode(!0);m.parentNode.replaceChild(p,m),u.parentNode.replaceChild(f,u),p.addEventListener("click",()=>{this.hideDialogs(),s&&s()}),f.addEventListener("click",()=>{this.hideDialogs(),a&&a()})}goToLine(){const e=parseInt(document.getElementById("goto-input").value);if(e>0){const t=this.tabs.find(i=>i.id===this.activeTabId);if(t&&t.textarea){const i=t.textarea.value.split(`
`);let n=0;for(let s=0;s<Math.min(e-1,i.length);s++)n+=i[s].length+1;t.textarea.focus(),t.textarea.setSelectionRange(n,n)}}this.hideDialogs()}showContextMenu(e){e.preventDefault();const t=this.elements.contextMenu;t.style.left=`${e.pageX}px`,t.style.top=`${e.pageY}px`,t.classList.remove("hidden")}setupEventListeners(){this.elements.newTabBtn&&this.elements.newTabBtn.addEventListener("click",()=>this.newFile());const e=document.getElementById("export-pdf-btn");e&&e.addEventListener("click",()=>this.exportAsPDF());const t=document.getElementById("close-ai-sidebar");t&&t.addEventListener("click",()=>{this.elements.aiSidebar.classList.add("hidden")}),this.elements.statusLineEnding&&this.elements.statusLineEnding.addEventListener("click",()=>this.toggleLineEnding()),this.elements.statusZoom&&this.elements.statusZoom.addEventListener("click",()=>this.resetZoom());const i=document.getElementById("find-close");i&&i.addEventListener("click",()=>this.hideDialogs());const n=document.getElementById("find-next-btn");n&&n.addEventListener("click",()=>this.findNext());const s=document.getElementById("find-prev-btn");s&&s.addEventListener("click",()=>this.findPrevious());const a=document.getElementById("replace-one-btn");a&&a.addEventListener("click",()=>this.replaceOne());const r=document.getElementById("replace-all-btn");r&&r.addEventListener("click",()=>this.replaceAll());const o=document.getElementById("goto-cancel");o&&o.addEventListener("click",()=>this.hideDialogs());const l=document.getElementById("goto-ok");l&&l.addEventListener("click",()=>this.goToLine())}setupKeyboardShortcuts(){this.shortcuts={new:{key:"n",ctrl:!0,shift:!1,action:()=>this.newFile()},open:{key:"o",ctrl:!0,shift:!1,action:()=>this.openFile()},save:{key:"s",ctrl:!0,shift:!1,action:()=>this.saveTab()},"save-as":{key:"s",ctrl:!0,shift:!0,action:()=>this.saveAs()},"export-pdf":{key:"e",ctrl:!0,shift:!0,action:()=>this.exportAsPDF()},find:{key:"f",ctrl:!0,shift:!1,action:()=>this.showFindReplaceDialog(!1)},replace:{key:"h",ctrl:!0,shift:!1,action:()=>this.showFindReplaceDialog(!0)},"go-to":{key:"g",ctrl:!0,shift:!1,action:()=>this.showGoToDialog()},"zoom-in":{key:"+",ctrl:!0,shift:!0,action:()=>this.zoomIn()},"zoom-out":{key:"-",ctrl:!0,shift:!1,action:()=>this.zoomOut()},"reset-zoom":{key:"0",ctrl:!0,shift:!1,action:()=>this.resetZoom()},"word-wrap":{key:"z",ctrl:!0,shift:!1,action:()=>this.toggleWordWrap()},"line-numbers":{key:"l",ctrl:!0,shift:!0,action:()=>this.toggleLineNumbers()},minimap:{key:"m",ctrl:!0,shift:!0,action:()=>this.toggleMinimap()},fullscreen:{key:"F11",ctrl:!1,shift:!1,action:()=>this.toggleFullscreen()},"ai-sidebar":{key:"a",ctrl:!0,shift:!0,action:()=>this.toggleAISidebar()}},document.addEventListener("keydown",e=>{if(e.key==="F11"){e.preventDefault(),e.stopPropagation(),this.toggleFullscreen();return}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==="a"){e.preventDefault(),e.stopPropagation(),this.toggleAISidebar();return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey){if(e.key==="+"||e.key==="="){e.preventDefault(),this.zoomIn();return}if(e.key==="-"){e.preventDefault(),this.zoomOut();return}if(e.key==="0"){e.preventDefault(),this.resetZoom();return}}for(const[t,i]of Object.entries(this.shortcuts)){if(t==="fullscreen"||t==="ai-sidebar")continue;const n=e.key.toLowerCase()===i.key.toLowerCase(),s=e.ctrlKey===i.ctrl||e.metaKey===i.ctrl,a=e.shiftKey===i.shift;if(n&&s&&a){if((e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&t!=="save"&&t!=="save-as"&&t!=="open"&&t!=="new"&&t!=="find"&&t!=="replace")continue;e.preventDefault(),i.action();return}}})}updateStatusBar(){const e=this.tabs.find(t=>t.id===this.activeTabId);e&&(this.elements.statusFile&&(this.elements.statusFile.textContent=e.fileInfo.Name),this.elements.statusEncoding&&(this.elements.statusEncoding.textContent=e.fileInfo.Encoding),this.elements.statusLineEnding&&(this.elements.statusLineEnding.textContent=e.fileInfo.LineEnding),this.elements.statusZoom&&(this.elements.statusZoom.textContent=`${this.zoomLevel}%`),this.updateCursorPosition(e))}getActiveTab(){return this.tabs.find(e=>e.id===this.activeTabId)}showAboutDialog(){this.elements.dialogOverlay.classList.remove("hidden");let e=document.getElementById("dialog-about");e||(e=document.createElement("div"),e.id="dialog-about",e.className="dialog hidden",e.style.width="450px",e.innerHTML=`
                <div class="dialog-header">About Akashic</div>
                <div class="dialog-body" style="text-align: center; padding: 30px;">
                    <img src="./logo.png" alt="Akashic Logo" style="width: 80px; height: 80px; margin-bottom: 20px; border-radius: 8px;">
                    <h2 style="margin-bottom: 10px; color: var(--accent-color);">Akashic Editor</h2>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">v0.2.0</p>
                    <p style="font-size: 13px; line-height: 1.6; margin-bottom: 20px;">
                        Akashic is an AI-enhanced text editor built with Wails and modern web technologies.
                        Designed for developers who want a lightweight yet powerful editing experience.
                    </p>
                </div>
                <div class="dialog-footer" style="justify-content: center;">
                    <button id="about-close" style="padding: 8px 24px;">Close</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(e),document.getElementById("about-close").addEventListener("click",()=>{this.hideDialogs()})),e.classList.remove("hidden")}showKeyboardShortcutsDialog(){this.elements.dialogOverlay.classList.remove("hidden");let e=document.getElementById("dialog-shortcuts");e||(e=document.createElement("div"),e.id="dialog-shortcuts",e.className="dialog hidden",e.style.width="500px",e.style.maxHeight="80vh",e.innerHTML=`
                <div class="dialog-header">Keyboard Shortcuts</div>
                <div class="dialog-body" style="padding: 0; max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead style="position: sticky; top: 0; background: var(--bg-secondary);">
                            <tr>
                                <th style="text-align: left; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">Action</th>
                                <th style="text-align: left; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">Shortcut</th>
                            </tr>
                        </thead>
                        <tbody id="shortcuts-list">
                        </tbody>
                    </table>
                </div>
                <div class="dialog-footer">
                    <button id="shortcuts-close">Close</button>
                </div>
            `,this.elements.dialogOverlay.appendChild(e),document.getElementById("shortcuts-close").addEventListener("click",()=>{this.hideDialogs()})),this.renderShortcutsList(),e.classList.remove("hidden")}renderShortcutsList(){const e=document.getElementById("shortcuts-list");if(!e)return;e.innerHTML="";const t={new:"New File",open:"Open File",save:"Save","save-as":"Save As","export-pdf":"Export as PDF",find:"Find",replace:"Replace","go-to":"Go To Line","zoom-in":"Zoom In","zoom-out":"Zoom Out","reset-zoom":"Reset Zoom","word-wrap":"Toggle Word Wrap","line-numbers":"Toggle Line Numbers",minimap:"Toggle Minimap",fullscreen:"Fullscreen","ai-sidebar":"Toggle AI Sidebar"};for(const[i,n]of Object.entries(this.shortcuts)){const s=document.createElement("tr");s.style.borderBottom="1px solid var(--border-color)";const a=[];n.ctrl&&a.push("Ctrl"),n.shift&&a.push("Shift"),a.push(n.key.toUpperCase()),s.innerHTML=`
                <td style="padding: 8px 15px; color: var(--text-primary);">${t[i]||i}</td>
                <td style="padding: 8px 15px;">
                    <kbd style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 12px;">
                        ${a.join("+")}
                    </kbd>
                </td>
            `,e.appendChild(s)}}setupWindowCloseHandler(){window.addEventListener("beforeunload",e=>{const t=this.tabs.filter(i=>i.fileInfo.IsDirty);t.length>0&&(e.preventDefault(),e.returnValue="",this.showSaveConfirmDialog("Unsaved Changes",`You have ${t.length} unsaved file(s). Save before closing?`,async()=>{await Promise.all(t.map(i=>this.saveTab(i))),window.removeEventListener("beforeunload",this),window.close()},()=>{window.removeEventListener("beforeunload",this),window.close()},()=>{}))})}exitApp(){const e=this.tabs.filter(t=>t.fileInfo.IsDirty);e.length>0?this.showSaveConfirmDialog("Unsaved Changes",`You have ${e.length} unsaved file(s). Save before exiting?`,()=>{Promise.all(e.map(t=>this.saveTab(t))).then(()=>{this.quitApplication()})},()=>{this.quitApplication()},()=>{}):this.quitApplication()}quitApplication(){window.go&&window.go.main&&window.go.main.App&&window.go.main.App.Quit?window.go.main.App.Quit():window.close()}async exportAsPDF(){const e=this.getActiveTab();if(!e||!e.textarea){this.showNotification("No file to export","warning");return}const t=e.textarea.value,i=e.fileInfo.Name.replace(/\\.[^/.]+$/,"")||"Untitled";if(!y){this.showNotification("PDF export not available","error");return}try{await y(t,i)}catch(n){console.error("Failed to export PDF:",n),this.showNotification("Failed to export PDF: "+(n.message||n),"error")}}async checkOllamaInstallation(){try{const e=await L();this.ollamaStatus=e;const t=document.getElementById("ai-status-indicator"),i=document.getElementById("ai-status-text"),n=document.getElementById("ai-setup-panel");e.installed?(t.className="status-dot online",i.textContent=`Ollama ${e.version}`,n.classList.add("hidden"),await this.loadInstalledModels(),await this.checkServerStatus()):(t.className="status-dot offline",i.textContent="Ollama not installed",n.classList.remove("hidden"))}catch(e){console.error("Failed to check Ollama:",e),this.showNotification("Failed to check Ollama installation","error")}}async loadInstalledModels(){try{const e=await x();this.installedModels=e;const t=document.getElementById("ai-model");t.innerHTML="",e.length===0?t.innerHTML='<option value="">No models installed</option>':(e.forEach(i=>{const n=document.createElement("option");n.value=i.name,n.textContent=`${i.name} (${i.size})`,t.appendChild(n)}),this.selectedModel=e[0].name,t.value=this.selectedModel),t.addEventListener("change",i=>{this.selectedModel=i.target.value})}catch(e){console.error("Failed to load models:",e)}}async checkServerStatus(){try{await x(),this.serverRunning=!0,this.updateServerStatusUI(!0)}catch{this.serverRunning=!1,this.updateServerStatusUI(!1)}}updateServerStatusUI(e){const t=document.getElementById("ai-status-indicator"),i=document.getElementById("ai-status-text"),n=document.getElementById("start-ollama-server");!t||!i||(e?(t.className="status-dot online",i.textContent="Server running",i.style.color="var(--success-color)",n&&n.classList.add("hidden")):(t.className="status-dot offline",i.textContent="Server not running",i.style.color="var(--error-color)",n&&n.classList.remove("hidden")))}async startOllamaServer(){try{this.showNotification("Starting Ollama server...","info"),await D(),this.showNotification("Ollama server started!","success"),this.serverRunning=!0,this.updateServerStatusUI(!0),document.getElementById("ai-chat-container").classList.remove("hidden")}catch(e){console.error("Failed to start server:",e),this.showNotification(e.message||"Failed to start server","error")}}async generateWithAI(){if(!this.selectedModel){this.showNotification("Please select a model first","warning");return}this.currentChatId||await this.createNewChat();const e=document.getElementById("ai-prompt"),t=e.value;if(!t.trim()){this.showNotification("Please enter a prompt","warning");return}const i=document.getElementById("ai-messages"),n=i.querySelector(".ai-welcome");n&&n.remove();const s=document.createElement("div");s.className="ai-message user",s.innerHTML=`<div class="ai-message-content">${this.escapeHtml(t)}</div>`,i.appendChild(s);const a=document.createElement("div");a.className="ai-message assistant",a.innerHTML='<div class="ai-message-content" style="color: var(--text-secondary); font-style: italic;">Generating...</div>',i.appendChild(a),e.value="",i.scrollTop=i.scrollHeight;try{await v(this.currentChatId,"user",t);const o=await S(this.currentChatId,10)+`

User: `+t+`

Assistant:`,l=await k(this.selectedModel,o);a.innerHTML=`<div class="ai-message-content" style="white-space: pre-wrap;">${this.escapeHtml(l)}</div>`,this.lastAIResponse=l,await v(this.currentChatId,"assistant",l);const h=this.chats.find(c=>c.id===this.currentChatId);h&&h.title==="New Chat"&&(await F(this.currentChatId),await this.loadChatHistory(),this.updateChatInfo())}catch(r){console.error("Generation failed:",r);const o=this.escapeHtml(r&&r.message?String(r.message):String(r));a.innerHTML=`<div class="ai-message-content" style="color: var(--error-color);">Error: ${o}</div>`}i.scrollTop=i.scrollHeight}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}insertAIResponse(){if(!this.lastAIResponse){this.showNotification("No AI response to insert","warning");return}const e=this.getActiveTab();if(!e||!e.textarea)return;const t=e.textarea.selectionStart,i=e.textarea.selectionEnd,n=e.textarea.value;e.textarea.value=n.substring(0,t)+this.lastAIResponse+n.substring(i),e.textarea.setSelectionRange(t+this.lastAIResponse.length,t+this.lastAIResponse.length),this.onEditorChange(e),this.showNotification("AI response inserted","success")}replaceWithAIResponse(){if(!this.lastAIResponse){this.showNotification("No AI response to insert","warning");return}const e=this.getActiveTab();if(!e||!e.textarea)return;const t=e.textarea.selectionStart,i=e.textarea.selectionEnd,n=e.textarea.value;e.textarea.value=n.substring(0,t)+this.lastAIResponse+n.substring(i),e.textarea.setSelectionRange(t,t+this.lastAIResponse.length),this.onEditorChange(e),this.showNotification("Text replaced with AI response","success")}setupAIEventListeners(){const e=document.getElementById("check-ollama-again");e&&e.addEventListener("click",()=>this.checkOllamaInstallation());const t=document.getElementById("start-ollama-server");t&&t.addEventListener("click",()=>this.startOllamaServer());const i=document.getElementById("ai-send");i&&i.addEventListener("click",()=>this.generateWithAI());const n=document.getElementById("ai-insert");n&&n.addEventListener("click",()=>this.insertAIResponse());const s=document.getElementById("ai-replace");s&&s.addEventListener("click",()=>this.replaceWithAIResponse()),document.querySelectorAll(".ai-suggestion").forEach(o=>{o.addEventListener("click",()=>{const l=o.dataset.prompt;document.getElementById("ai-prompt").value=l,this.updateSendButtonState(),this.generateWithAI()})});const a=document.getElementById("ai-prompt");a&&(a.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this.generateWithAI())}),a.addEventListener("input",()=>{this.updateSendButtonState()}));const r=document.getElementById("ai-model");r&&r.addEventListener("change",()=>{this.updateSendButtonState()}),this.updateSendButtonState()}updateSendButtonState(){const e=document.getElementById("ai-send"),t=document.getElementById("ai-prompt"),i=document.getElementById("ai-model");if(!e||!t||!i)return;const n=t.value.trim().length>0,s=i.value&&i.value!=="";e.disabled=!(n&&s)}}window.akashic=new R;
